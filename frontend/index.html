<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gửi API Cheap Pools</title>
</head>
<body>
    <h2>Nhập Dữ Liệu Gửi API</h2>
    <form id="apiForm">
        <label for="ticket_type">Loại vé:</label>
        <select id="ticket_type">
            <option value="children_price">Trẻ em</option>
            <option value="adult_price">Người lớn</option>
            <option value="student_price">Sinh viên</option>
        </select>
        <br><br>

        <label>Dịch vụ:</label><br>
        <input type="checkbox" name="services" value="2"> Dịch vụ 2<br>
        <input type="checkbox" name="services" value="3"> Dịch vụ 3<br>
        <br>

        <button type="button" onclick="sendRequest()">Gửi Yêu Cầu</button>
    </form>

    <h3>Kết quả:</h3>
    <pre id="response"></pre>
    <ul id="poolList"></ul>

    <button type="button" onclick="fetchAllPools()">Lấy danh sách hồ bơi</button>
    <ul id="allPoolsList"></ul>

    <script>
        async function sendRequest() {
            const ticketType = document.getElementById("ticket_type").value;
            const checkboxes = document.querySelectorAll("input[name='services']:checked");
            const services = Array.from(checkboxes).map(cb => cb.value);

            const lat = 10.02986040707733;
            const lng = 105.77074336482;

            if (!ticketType) {
                alert("Vui lòng chọn loại vé!");
                return;
            }

            const queryParams = new URLSearchParams({
                ticket_type: ticketType,
                lat: lat,
                lng: lng
            });

            services.forEach(service => queryParams.append("services[]", service));

            const apiUrl = `http://127.0.0.1:8000/api/pools/cheapPools?${queryParams}`;

            try {
                const response = await fetch(apiUrl, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                document.getElementById("response").innerText = JSON.stringify(result, null, 2);

                const poolList = document.getElementById("poolList");
                poolList.innerHTML = "";

                if (result.status === "success" && result.data.length > 0) {
                    result.data.forEach(pool => {
                        const li = document.createElement("li");
                        li.innerHTML = `<strong>${pool.name}</strong> - Giá: ${pool.total_cost} VND - Khoảng cách: ${pool.distance_km.toFixed(2)} km`;
                        poolList.appendChild(li);
                    });
                } else {
                    poolList.innerHTML = "<li>Không tìm thấy hồ bơi phù hợp.</li>";
                }
            } catch (error) {
                document.getElementById("response").innerText = "Lỗi: " + error.message;
            }
        }

        async function fetchAllPools() {
            const apiUrl = "http://127.0.0.1:8000/api/pools/";

            try {
                const response = await fetch(apiUrl, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                document.getElementById("response").innerText = JSON.stringify(result, null, 2);

                const allPoolsList = document.getElementById("allPoolsList");
                allPoolsList.innerHTML = "";

                if (result.status === "success" && result.data.length > 0) {
                    result.data.forEach(pool => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <strong>${pool.name}</strong> - Loại: ${pool.type} <br>
                            Giá trẻ em: ${pool.children_price || "N/A"} VND, 
                            Người lớn: ${pool.adult_price || "N/A"} VND, 
                            Sinh viên: ${pool.student_price || "N/A"} VND <br>
                            <img src="${pool.img || 'https://via.placeholder.com/200'}" alt="Ảnh hồ bơi" width="200"> <br>
                            Địa chỉ: ${pool.house_number || ''}, ${pool.street?.name || ''}, ${pool.street?.ward?.name || ''}, ${pool.street?.district?.name || ''}
                        `;
                        allPoolsList.appendChild(li);
                    });
                } else {
                    allPoolsList.innerHTML = "<li>Không có hồ bơi nào.</li>";
                }
            } catch (error) {
                document.getElementById("response").innerText = "Lỗi: " + error.message;
            }
        }
    </script>
</body>
</html>
