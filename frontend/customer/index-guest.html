<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω h·ªì b∆°i</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index-guest.html">Qu·∫£n l√Ω h·ªì b∆°i</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="btn btn-light text-primary" href="login.html"><i class="fa-solid fa-user text-blue"
                                style="font-size: 1rem;"></i> ƒêƒÉng nh·∫≠p</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-3">
        <div class="row">

            <div class="row">
                <!-- Sidebar: T√¨m ki·∫øm h·ªì b∆°i -->
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">T√¨m ki·∫øm h·ªì b∆°i</div>
                        <div class="card-body">
                            <form id="searchForm" onsubmit="event.preventDefault(); searchPools();">
                                <div class="mb-3">
                                    <label for="type" class="form-label">Lo·∫°i h√¨nh h·ªì b∆°i</label>
                                    <select class="form-select" id="type">
                                        <option value="all">T·∫•t c·∫£</option>
                                        <option value="public">H√¥ÃÄ b∆°i c√¥ng c·ªông</option>
                                        <option value="private">H√¥ÃÄ b∆°i t∆∞ nh√¢n</option>
                                        <option value="children">H√¥ÃÄ b∆°i tr·∫ª em</option>
                                        <option value="contest">H√¥ÃÄ b∆°i thi ƒë·∫•u</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="distance" class="form-label">Kho·∫£ng c√°ch (km)</label>
                                    <input type="number" class="form-control" id="distance"
                                        placeholder="Nh·∫≠p kho·∫£ng c√°ch">
                                </div>
                                <div class="mb-3">
                                    <label for="maxFee" class="form-label">Ph√≠ t·ªëi ƒëa (VNƒê)</label>
                                    <input type="number" class="form-control" id="maxFee" placeholder="Nh·∫≠p ph√≠ t·ªëi ƒëa">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">T√¨m
                                    ki·∫øm</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Main: B·∫£n ƒë·ªì -->
                <div class="col-md-8">
                    <div id="map" style="height: 500px; width: 100%;"></div>
                </div>
            </div>

        </div>

        <br>
        <!-- Danh s√°ch h·ªì b∆°i -->
        <div class="card" id="poolListContainer">
            <div class="card-header bg-primary text-white">Danh s√°ch h·ªì b∆°i</div>
            <div class="card-body">
                <div class="row" id="poolList"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-primary text-white text-center py-3 mt-3">
            <p>&copy; 2025 Qu·∫£n l√Ω h·ªì b∆°i. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </footer>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <!-- Custom JS -->
        <script src="js/main.js"></script>

        <!-- Leaflet Routing Machine JS -->
        <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

        <!-- Custom JS -->
        <script>
            async function searchPools() {
                console.log("üîç B·∫Øt ƒë·∫ßu t√¨m ki·∫øm h·ªì b∆°i...");

                const typeElement = document.getElementById("type");
                const distanceElement = document.getElementById("distance");
                const maxFeeElement = document.getElementById("maxFee");
                const poolList = document.getElementById("poolList");

                if (!typeElement || !distanceElement || !maxFeeElement || !poolList) {
                    console.error("‚ùå M·ªôt ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠ ƒë·∫ßu v√†o kh√¥ng t√¨m th·∫•y.");
                    alert("L·ªói: M·ªôt ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠ ƒë·∫ßu v√†o kh√¥ng t·ªìn t·∫°i tr√™n trang!");
                    return;
                }

                let type = typeElement.options[typeElement.selectedIndex].text.trim();
                let distance = parseFloat(distanceElement.value);
                let maxFee = parseFloat(maxFeeElement.value);

                if (isNaN(distance) || distance < 0 || isNaN(maxFee) || maxFee < 0) {
                    alert("‚ö†Ô∏è Kho·∫£ng c√°ch v√† ph√≠ t·ªëi ƒëa ph·∫£i l√† s·ªë d∆∞∆°ng h·ª£p l·ªá!");
                    return;
                }

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        console.log(`üìç V·ªã tr√≠ hi·ªán t·∫°i: ${lat}, ${lng}`);

                        const encodedType = encodeURIComponent(type);

                        let apiUrl = `http://127.0.0.1:8000/api/pools/search?type=${encodedType}&maxFee=${maxFee}&lat=${lat}&distance=${distance}&lng=${lng}`;

                        console.log(`üîó G·ªçi API: ${apiUrl}`);

                        try {
                            const response = await fetch(apiUrl);
                            if (!response.ok) {
                                throw new Error(`L·ªói API: ${response.status} - ${response.statusText}`);
                            }

                            const result = await response.json();
                            if (!result || !result.data || result.data.length === 0) {
                                poolList.innerHTML = "<p class='text-danger'>‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h·ªì b∆°i ph√π h·ª£p!</p>";
                                return;
                            }

                            const pools = result.data.map(pool => ({
                                id: pool.id,
                                name: pool.name,
                                lat: pool.lat,
                                lng: pool.lng,
                                address: `${pool.house_number || "N/A"}, ${pool.street?.name || "N/A"}, ${pool.street?.ward?.name || "N/A"}, ${pool.street?.ward?.district?.name || "N/A"}`,
                                price: {
                                    adult: `${pool.adult_price} VNƒê`,
                                    child: `${pool.children_price} VNƒê`,
                                    student: `${pool.student_price} VNƒê`
                                },
                                image: pool.img
                            }));

                            // Hi·ªÉn th·ªã danh s√°ch h·ªì b∆°i
                            poolList.innerHTML = pools.map(pool => `
                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                        <img src="${pool.image}" class="card-img-top" alt="H·ªì b∆°i ${pool.name}">
                                        <div class="card-body">
                                            <a href="pool-detail-customer.html?poolId=${pool.id}" class="card-title">
                                                <h5>${pool.name}</h5>
                                            </a>
                                            <p class="card-text">üìç ƒê·ªãa ch·ªâ: ${pool.address}</p>
                                            <h6><strong>üí∞ Ph√≠ v√†o c·ªïng:</strong></h6>
                                            <ul class="list-unstyled">
                                                <li><strong>üë®‚Äçü¶≥ Ng∆∞·ªùi l·ªõn:</strong> ${pool.price.adult}</li>
                                                <li><strong>üßí Tr·∫ª em:</strong> ${pool.price.child}</li>
                                                <li><strong>üéì H·ªçc sinh/Sinh vi√™n:</strong> ${pool.price.student}</li>
                                            </ul>
                                            <button class="btn btn-primary" onclick="displayRoute([${pool.lat}, ${pool.lng}])">üìç Hi·ªÉn th·ªã l·ªô tr√¨nh</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('');

                            renderPools(pools);
                            renderMarker(pools);
                        } catch (error) {
                            console.error("‚ùå L·ªói khi g·ªçi API:", error);
                            alert("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
                        }
                    }, function (error) {
                        console.error("‚ùå L·ªói khi l·∫•y v·ªã tr√≠ ng∆∞·ªùi d√πng:", error);
                        alert("‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n! Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t tr√¨nh duy·ªát.");
                    });
                } else {
                    alert("‚ùå Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!");
                }
            }


            function logout() {
                // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage
                const authToken = localStorage.getItem("authToken");  // L·∫•y token t·ª´ "authToken"

                if (!authToken) {
                    alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
                    return;  // N·∫øu kh√¥ng c√≥ token, th√¥ng b√°o v√† d·ª´ng l·∫°i
                }

                // G·ª≠i y√™u c·∫ßu POST t·ªõi API ƒë·ªÉ ƒëƒÉng xu·∫•t
                fetch("http://127.0.0.1:8000/api/logout", {
                    method: "POST",  // S·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c POST
                    headers: {
                        "Content-Type": "application/json",  // ƒê·∫£m b·∫£o g·ª≠i d·ªØ li·ªáu ·ªü d·∫°ng JSON
                        "Authorization": `Bearer ${authToken}`  // G·ª≠i token qua header Authorization
                    }
                })
                    .then(response => response.json())  // Chuy·ªÉn ph·∫£n h·ªìi t·ª´ server th√†nh JSON
                    .then(data => {
                        // Ki·ªÉm tra m√£ tr·∫°ng th√°i ph·∫£n h·ªìi
                        if (data.status === 200) {
                            alert("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
                            // X√≥a th√¥ng tin ng∆∞·ªùi d√πng v√† token kh·ªèi localStorage
                            localStorage.removeItem("authToken");
                            localStorage.removeItem("loggedInUser");
                            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p
                            window.location.href = "login.html";
                        } else {
                            // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                            alert(data.message || "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
                        }
                    })
                    .catch(error => {
                        // X·ª≠ l√Ω l·ªói n·∫øu c√≥ s·ª± c·ªë khi g·ªçi API
                        console.error("L·ªói khi g·ªçi API logout:", error);
                        alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
                    });
            }

            async function fetchPools() {
                try {
                    const response = await fetch("http://127.0.0.1:8000/api/pools");
                    const result = await response.json();
                    console.log("D·ªØ li·ªáu t·ª´ API:", result); // Ki·ªÉm tra d·ªØ li·ªáu API
                    return result.data; // API c√≥ th·ªÉ tr·∫£ v·ªÅ object ch·ª©a `data`
                } catch (error) {
                    console.error("L·ªói khi l·∫•y d·ªØ li·ªáu h·ªì b∆°i:", error);
                    return [];
                }
            }

            // G·ªçi h√†m ƒë·ªÉ l·∫•y d·ªØ li·ªáu
            fetchPools();
            async function fetchAndRenderPools() {
                try {
                    const response = await fetch("http://127.0.0.1:8000/api/pools");
                    const result = await response.json(); // Nh·∫≠n to√†n b·ªô response

                    // Ki·ªÉm tra API c√≥ tr·∫£ v·ªÅ danh s√°ch h·ªì b∆°i kh√¥ng
                    if (!result.data || !Array.isArray(result.data)) {
                        console.error("D·ªØ li·ªáu API kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ph·∫£i l√† m·∫£ng", result);
                        return;
                    }

                    const pools = result.data.map(pool => ({
                        name: pool.name,
                        lat: pool.lat,
                        lng: pool.lng,
                        address: `${pool.house_number || "N/A"}, ${pool.street?.name || "N/A"}, ${pool.street?.ward?.name || "N/A"}, ${pool.street?.ward?.district?.name || "N/A"}`,
                        price: {
                            adult: `${pool.adult_price} VNƒê`,
                            child: `${pool.children_price} VNƒê`,
                            student: `${pool.student_price} VNƒê`
                        },
                        image: pool.img
                    }));

                    renderPools(pools);
                    renderMarker(pools);
                } catch (error) {
                    console.error("L·ªói khi l·∫•y d·ªØ li·ªáu h·ªì b∆°i:", error);
                }
            }

            // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
            var map = L.map('map').setView([10.762622, 106.660172], 13); // To·∫° ƒë·ªô trung t√¢m

            // Th√™m l·ªõp b·∫£n ƒë·ªì OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            let markers = []; // L∆∞u danh s√°ch markers

            function renderMarker(pools) {
                // X√≥a t·∫•t c·∫£ marker c≈© tr∆∞·ªõc khi th√™m marker m·ªõi
                markers.forEach(marker => map.removeLayer(marker));
                markers = []; // Reset danh s√°ch marker

                pools.forEach(function (pool) {
                    var poolLocation = [pool.lat, pool.lng];

                    // T·∫°o marker m·ªõi v√† th√™m v√†o b·∫£n ƒë·ªì
                    var marker = L.marker(poolLocation).addTo(map);

                    // Th√™m popup v·ªõi t√™n v√† ƒë·ªãa ch·ªâ c·ªßa h·ªì b∆°i
                    marker.bindPopup(`<b>${pool.name}</b><br>ƒê·ªãa ch·ªâ: ${pool.address}`).openPopup();

                    // L·∫Øng nghe s·ª± ki·ªán click ƒë·ªÉ hi·ªÉn th·ªã l·ªô tr√¨nh
                    marker.on('click', function () {
                        document.getElementById('getDirectionsBtn').onclick = function () {
                            displayRoute(poolLocation);
                        };
                    });

                    // L∆∞u marker v√†o danh s√°ch ƒë·ªÉ c√≥ th·ªÉ x√≥a sau n√†y
                    markers.push(marker);
                });
            }

            let routeControl = null; // L∆∞u tuy·∫øn ƒë∆∞·ªùng hi·ªán t·∫°i

            function displayRoute(poolLocation) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var userLocation = [position.coords.latitude, position.coords.longitude];

                        // N·∫øu ƒë√£ c√≥ tuy·∫øn ƒë∆∞·ªùng c≈©, xo√° tr∆∞·ªõc khi t·∫°o m·ªõi
                        if (routeControl !== null) {
                            map.removeControl(routeControl);
                        }

                        // T·∫°o tuy·∫øn ƒë∆∞·ªùng m·ªõi
                        routeControl = L.Routing.control({
                            waypoints: [
                                L.latLng(userLocation),
                                L.latLng(poolLocation)
                            ],
                            routeWhileDragging: true
                        }).addTo(map);

                    }, function (error) {
                        console.error("‚ùå L·ªói khi l·∫•y v·ªã tr√≠ ng∆∞·ªùi d√πng:", error);
                        alert("‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n! Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t tr√¨nh duy·ªát.");
                    });
                } else {
                    alert("‚ùå Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!");
                }
            }

            function renderPools(pools) {
                const poolList = document.getElementById("poolList");
                poolList.innerHTML = ""; // X√≥a danh s√°ch c≈©

                pools.forEach((pool, index) => {
                    if (index % 3 === 0) {
                        poolList.insertAdjacentHTML('beforeend', '<div class="w-100"></div>');
                    }

                    poolList.insertAdjacentHTML('beforeend', `
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <!-- Ch·ªânh s·ª≠a ·ªü ƒë√¢y: d√πng th·∫ª <a> thay v√¨ th·∫ª <h5> -->
                                <a href="pool-detail-customer.html?poolId=${pool.id}" class="card-title">
                                    <h5>${pool.name}</h5>
                                </a>
                                <p class="card-text">üìç ƒê·ªãa ch·ªâ: ${pool.address}</p>
                                <h6><strong>üí∞ Ph√≠ v√†o c·ªïng:</strong></h6>
                                <ul class="list-unstyled">
                                    <li><strong>üë®‚Äçü¶≥ Ng∆∞·ªùi l·ªõn:</strong> ${pool.price.adult}</li>
                                    <li><strong>üßí Tr·∫ª em:</strong> ${pool.price.child}</li>
                                    <li><strong>üéì H·ªçc sinh/Sinh vi√™n:</strong> ${pool.price.student}</li>
                                </ul>
                                <button class="btn btn-primary" onclick="displayRoute([${pool.lat}, ${pool.lng}])">üìç Hi·ªÉn th·ªã l·ªô tr√¨nh</button>
                            </div>
                        </div>
                    </div>
                `);
                });
            }

            // G·ªçi h√†m ƒë·ªÉ l·∫•y d·ªØ li·ªáu v√† hi·ªÉn th·ªã
            fetchAndRenderPools();

        </script>

</body>

</html>