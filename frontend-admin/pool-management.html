<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Hồ Bơi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Quản Lý Tiện Ích</a>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link active" href="index.html">Trang Chủ</a></li>
            <li class="nav-item"><a class="nav-link" href="pool-management.html">Quản Lý Hồ Bơi</a></li>
            <li class="nav-item"><a class="nav-link" href="service-management.html">Quản Lý Dịch Vụ</a></li>
            <li class="nav-item"><a class="nav-link" href="service-management2.html">Quản Lý Dịch Vụ Của Hồ Bơi</a></li>
            <li class="nav-item"><a class="nav-link active" href="event-management.html">Quản Lý Sự Kiện</a></li>
            <li class="nav-item"><a class="nav-link" href="facility-management.html">Quản Lý Tiện Ích</a></li>
            <li class="nav-item"><a class="nav-link" href="registration-management.html">Quản Lý Phiếu Đăng Ký</a></li>
            <li class="nav-item"><a class="nav-link" href="infor-customer.html">Thông Tin Khách Hàng</a></li>
            <li class="nav-item"><a class="nav-link" href="review-management.html">Đánh Giá Khách Hàng</a></li>
        </ul>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="img/admin.jpg" alt="Admin" class="rounded-circle" style="width: 30px; height: 30px; margin-right: 8px;">
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                    <li><a class="dropdown-item" href="profile.html">Hồ Sơ</a></li>
                    <li><a class="dropdown-item text-danger" href="logout.html">Đăng Xuất</a></li>
                </ul>
            </li>
        </ul>
        </div>
    </nav>
    <div class="container mt-5">
        <h2>Danh Sách Hồ Bơi</h2>
        <button id="addPoolBtn" class="btn btn-primary mb-3">Thêm Hồ Bơi</button>

        <input type="text" id="searchPool" class="form-control mb-3" placeholder="Tìm kiếm hồ bơi...">

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Hình Ảnh</th>
                    <th>Tên Hồ Bơi</th>
                    <th>Loại</th>
                    <th>Địa chỉ</th>
                    <th>Kích thước (m)</th>
                    <th>Độ sâu (m)</th>
                    <th>Giá vé trẻ em</th>
                    <th>Giá vé người lớn</th>
                    <th>Giá vé học sinh</th>
                    <th>Giờ Mở</th>
                    <th>Giờ Đóng</th>
                    <th>Đánh giá trung bình</th>
                    <th>Tổng số đánh giá</th>
                    <th>Thao Tác</th>
                </tr>
            </thead>
            <tbody id="poolList"></tbody>
        </table>
    </div>

    <!-- Modal Thêm Hồ Bơi -->
    <div class="modal fade" id="addPoolModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm Hồ Bơi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPoolForm">
                        <div class="mb-3">
                            <label>Hình ảnh</label>
                            <input type="file" class="form-control" id="addPoolImage">
                        </div>

                        <div class="mb-3">
                            <label>Tên Hồ Bơi</label>
                            <input type="text" class="form-control" id="addPoolName" required>
                        </div>

                        <div class="mb-3">
                            <label>Loại Hồ Bơi</label>
                            <select class="form-control" id="addPoolType">
                                <option value="Hồ bơi công cộng">Hồ bơi công cộng</option>
                                <option value="Hồ bơi tư nhân">Hồ bơi tư nhân</option>
                                <option value="Hồ bơi trẻ em">Hồ bơi trẻ em</option>
                                <option value="Hồ bơi thi đấu">Hồ bơi thi đấu</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Địa chỉ</label>
                            <input type="text" class="form-control" id="addHouseNumber" placeholder="Số nhà">
                            <input type="text" class="form-control mt-2" id="addStreetName" placeholder="Tên đường">
                            <input type="text" class="form-control mt-2" id="addWardName" placeholder="Phường">
                            <input type="text" class="form-control mt-2" id="addDistrictName" placeholder="Quận">
                        </div>

                        <div class="mb-3">
                            <label>Kích thước (m)</label>
                            <input type="number" class="form-control" id="addPoolLength" placeholder="Dài">
                            <input type="number" class="form-control mt-2" id="addPoolWidth" placeholder="Rộng">
                        </div>

                        <div class="mb-3">
                            <label>Độ sâu (m)</label>
                            <input type="number" class="form-control" id="addPoolDepth">
                        </div>

                        <div class="mb-3">
                            <label>Giá vé (VND)</label>
                            <input type="number" class="form-control" id="addChildrenPrice" placeholder="Trẻ em">
                            <input type="number" class="form-control mt-2" id="addAdultPrice" placeholder="Người lớn">
                            <input type="number" class="form-control mt-2" id="addStudentPrice" placeholder="Học sinh">
                        </div>

                        <div class="mb-3">
                            <label>Giờ Mở</label>
                            <input type="time" class="form-control" id="addOpeningHours" required>
                        </div>

                        <div class="mb-3">
                            <label>Giờ Đóng</label>
                            <input type="time" class="form-control" id="addClosingHours" required>
                        </div>

                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Sửa Hồ Bơi -->
    <div class="modal fade" id="editPoolModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh Sửa Hồ Bơi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPoolForm">
                        <input type="hidden" id="editPoolId">

                        <div class="mb-3">
                            <label>Hình ảnh</label>
                            <input type="file" class="form-control" id="editPoolImage">
                        </div>

                        <div class="mb-3">
                            <label>Tên Hồ Bơi</label>
                            <input type="text" class="form-control" id="editPoolName" required>
                        </div>

                        <div class="mb-3">
                            <label>Loại Hồ Bơi</label>
                            <select class="form-control" id="editPoolType">
                                <option value="Hồ bơi công cộng">Hồ bơi công cộng</option>
                                <option value="Hồ bơi tư nhân">Hồ bơi tư nhân</option>
                                <option value="Hồ bơi trẻ em">Hồ bơi trẻ em</option>
                                <option value="Hồ bơi thi đấu">Hồ bơi thi đấu</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Địa chỉ</label>
                            <input type="text" class="form-control" id="editHouseNumber" placeholder="Số nhà">
                            <input type="text" class="form-control mt-2" id="editStreetName" placeholder="Tên đường">
                            <input type="text" class="form-control mt-2" id="editWardName" placeholder="Phường">
                            <input type="text" class="form-control mt-2" id="editDistrictName" placeholder="Quận">
                        </div>

                        <div class="mb-3">
                            <label>Kích thước (m)</label>
                            <input type="number" class="form-control" id="editPoolLength" placeholder="Dài">
                            <input type="number" class="form-control mt-2" id="editPoolWidth" placeholder="Rộng">
                        </div>

                        <div class="mb-3">
                            <label>Độ sâu (m)</label>
                            <input type="number" class="form-control" id="editPoolDepth">
                        </div>

                        <div class="mb-3">
                            <label>Giá vé (VND)</label>
                            <input type="number" class="form-control" id="editChildrenPrice" placeholder="Trẻ em">
                            <input type="number" class="form-control mt-2" id="editAdultPrice" placeholder="Người lớn">
                            <input type="number" class="form-control mt-2" id="editStudentPrice" placeholder="Học sinh">
                        </div>

                        <div class="mb-3">
                            <label>Giờ Mở</label>
                            <input type="time" class="form-control" id="editOpeningHours" required>
                        </div>

                        <div class="mb-3">
                            <label>Giờ Đóng</label>
                            <input type="time" class="form-control" id="editClosingHours" required>
                        </div>

                        <button type="submit" class="btn btn-primary">Cập Nhật</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
       $(document).ready(function () {
        let authToken = localStorage.getItem("authToken") || "";

        // HÀM TẢI DANH SÁCH HỒ BƠI
        function loadPools() {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:8000/api/pools",
                headers: { "Authorization": `Bearer ${authToken}` },
                success: function (response) {
                    let pools = response.data || [];
                    let poolList = pools.map((pool, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td><img src="${pool.img}" alt="Hình ảnh hồ bơi" width="100"></td>
                            <td>${pool.name}</td>
                            <td>${pool.type}</td>
                            <td>${pool.house_number || ''}, ${pool.street?.name || ''}, ${pool.street?.ward?.name || ''}, ${pool.street?.ward?.district?.name || ''}</td>
                            <td>${pool.length} x ${pool.width} m</td>
                            <td>${pool.depth} m</td>
                            <td>${pool.children_price} VND</td>
                            <td>${pool.adult_price} VND</td>
                            <td>${pool.student_price} VND</td>
                            <td>${pool.opening_hours}</td>
                            <td>${pool.close_hours}</td>
                            <td>${pool.average_rating || 0}</td>
                            <td>${pool.total_reviews || 0}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-btn" data-id="${pool.id_pool}" data-name="${pool.name}" data-type="${pool.type}" data-open="${pool.opening_hours}" data-close="${pool.closing_hours}">Sửa</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${pool.id_pool}">Xóa</button>
                            </td>
                        </tr>
                    `).join('');
                    $("#poolList").html(poolList);
                },
                error: function (xhr, status, error) {
                    console.error("Lỗi khi tải danh sách hồ bơi: ", error);
                    alert("Không thể tải danh sách hồ bơi.");
                }
            });
        }

        //Gọi hàm load danh sách hồ bơi ngay khi trang tải
        loadPools();

        //MỞ MODAL THÊM HỒ BƠI
        $("#addPoolBtn").click(function () {
            $("#addPoolForm")[0].reset();
            new bootstrap.Modal($("#addPoolModal")).show();
        });

        // THÊM HỒ BƠI
        $("#addPoolForm").submit(function (e) {
            e.preventDefault();
            
            let data = {
                name: $("#addPoolName").val(),
                type: $("#addPoolType").val(),
                house_number: $("#addHouseNumber").val(),
                street: $("#addStreetName").val(),
                ward: $("#addWardName").val(),
                district: $("#addDistrictName").val(),
                length: $("#addPoolLength").val(),
                width: $("#addPoolWidth").val(),
                depth: $("#addPoolDepth").val(),
                children_price: $("#addChildrenPrice").val(),
                adult_price: $("#addAdultPrice").val(),
                student_price: $("#addStudentPrice").val(),
                opening_hours: $("#addOpeningHours").val(),
                close_hours: $("#addClosingHours").val()
            };

            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:8000/api/pools/create",
                headers: { "Authorization": `Bearer ${authToken}` },
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function () {
                    $("#addPoolModal").modal("hide");
                    alert("Thêm hồ bơi thành công!");
                    loadPools();
                },
                error: function (xhr, status, error) {
                    console.error("Lỗi khi thêm hồ bơi: ", error);
                    alert("Đã xảy ra lỗi khi thêm hồ bơi.");
                }
            });
        });

        //MỞ MODAL CHỈNH SỬA HỒ BƠI
    $(document).on("click", ".edit-btn", function () {
        let pool = $(this).data();

        // Điền dữ liệu vào form chỉnh sửa
        $("#editPoolId").val(pool.id);
        $("#editPoolName").val(pool.name);
        $("#editPoolType").val(pool.type);
        $("#editHouseNumber").val(pool.house_number);
        $("#editStreetName").val(pool.street_name);
        $("#editWardName").val(pool.ward_name);
        $("#editDistrictName").val(pool.district_name);
        $("#editPoolLength").val(pool.length);
        $("#editPoolWidth").val(pool.width);
        $("#editPoolDepth").val(pool.depth);
        $("#editChildrenPrice").val(pool.children_price);
        $("#editAdultPrice").val(pool.adult_price);
        $("#editStudentPrice").val(pool.student_price);
        $("#editOpeningHours").val(pool.opening_hours);
        $("#editClosingHours").val(pool.closing_hours);

        new bootstrap.Modal($("#editPoolModal")).show();
    });

    //CẬP NHẬT HỒ BƠI
    $("#editPoolForm").submit(function (e) {
        e.preventDefault();
        let id = $("#editPoolId").val();
        if (!id) return; // Nếu không có ID thì không cập nhật

        // Tạo đối tượng FormData để gửi cả file ảnh (nếu có)
        let formData = new FormData();
        formData.append("name", $("#editPoolName").val());
        formData.append("type", $("#editPoolType").val());
        formData.append("house_number", $("#editHouseNumber").val());
        formData.append("street_name", $("#editStreetName").val());
        formData.append("ward_name", $("#editWardName").val());
        formData.append("district_name", $("#editDistrictName").val());
        formData.append("length", $("#editPoolLength").val());
        formData.append("width", $("#editPoolWidth").val());
        formData.append("depth", $("#editPoolDepth").val());
        formData.append("children_price", $("#editChildrenPrice").val());
        formData.append("adult_price", $("#editAdultPrice").val());
        formData.append("student_price", $("#editStudentPrice").val());
        formData.append("opening_hours", $("#editOpeningHours").val());
        formData.append("closing_hours", $("#editClosingHours").val());

        // Kiểm tra nếu có ảnh mới thì thêm vào formData
        let imageFile = $("#editPoolImage")[0].files[0];
        if (imageFile) {
            formData.append("image", imageFile);
        }

        $.ajax({
            type: "POST", // Sử dụng POST thay vì PATCH vì có file ảnh
            url: `http://127.0.0.1:8000/api/pools/${id}`,
            headers: { "Authorization": `Bearer ${authToken}` },
            processData: false, // Không xử lý dữ liệu formData
            contentType: false, // Không đặt contentType (để tự động thiết lập đúng kiểu multipart/form-data)
            data: formData,
            success: function () {
                $("#editPoolModal").modal("hide");
                alert("Cập nhật hồ bơi thành công!");
                loadPools();
            },
            error: function (xhr, status, error) {
                console.error("Lỗi khi cập nhật hồ bơi: ", error);
                alert("Đã xảy ra lỗi khi cập nhật hồ bơi.");
            }
        });
    });


        // XÓA HỒ BƠI
        $(document).on("click", ".delete-btn", function () {
            let poolId = $(this).data("id");

            if (confirm("Bạn có chắc chắn muốn xóa hồ bơi này không?")) {
                $.ajax({
                    type: "DELETE",
                    url: `http://127.0.0.1:8000/api/pools/${poolId}`,
                    headers: { "Authorization": `Bearer ${authToken}` },
                    success: function () {
                        alert("Xóa hồ bơi thành công!");
                        loadPools();
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi xóa hồ bơi: ", error);
                        alert("Đã xảy ra lỗi khi xóa hồ bơi.");
                    }
                });
            }
        });
    });

    </script>
</body>
</html>
